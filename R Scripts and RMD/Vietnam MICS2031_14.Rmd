---
title: "Vietnam MICS 2013-14 (Well Being Index)"
author: "Ayush Patel"
date: "`r Sys.Date()`"
output: 
  html_document: 
    number_sections: yes
    toc: yes
---

## Introduction

This HTML notebook will replicate the STATA do file named __vnm_mics14_dp2019 for distribution__ in R. The goal is to create an R script that does what the said do file does.

I will follow the same section numbering as in the do file for ease of comparision.

## Libraries

Before we go into the excercise, following are the packages from which we will use various functions.

```{r Libraries}
library(here)
library(tidyverse)
library(janitor)
library(haven)
library(gt)
library(readr)
```

## Building a Well-Being Index from Vietnam MICS 2013-14

The memory and environment clearing commands and the commands for setting working folders and paths are not needed if one is working in Project mode through RStudio and uses the {here} (read as package here). This is a library for managing paths and directories.

## Vietnam MICS 2014

### Step 1: Data Preparation

__ Selecting main variables from CH, WM, HH & MN recode & merging with HL recode __

It should be noted that anthropometric data was not collected for children under 5 as part of the Viet Nam MICS 2014 dataset. Previously, nutrition data was collected as part of Viet Nam MICS 2011. However, the data was not collected in this round due to time and resource constraints as well as the availability of national nutrition survey data (p.61)

_Above comments are copied from the STATA do file_

#### Step 1.1: CH - Children's Recode (Under 5)

According to the STATA do file there is no data for this section.

#### Step 1.2: BH - Birth Recode (All females 15-49 years who ever gave birth)

The purpose of step 1.2 is to identify children of any age who died in the last 5 years prior to the survey date. _As seen in the STATA file_

Loading the data from bh.sav.

```{r load_bh}
bh_dat <- read_sav(file = here("Viet Nam_MICS5_Datasets",
                     "Viet Nam MICS 2013-14 SPSS Datasets",
                     "bh.sav"))

bh_dat <- clean_names(bh_dat)
```

The above code chunk loads the bh.sav and names it bh_dat(a data object). The clean names function gets all the variable names in lower snake case. IN case if anyone is wondering what are all the possible cases, please refere to the wonderful art by Allison Horst shown below.

![Various Cases (Let me know your favourite)](coding_cases.png)

Now let us take a glimplse at the data and names of the variables.

```{r varnames}
names(bh_dat)
```

```{r peek}
head(bh_dat) %>% gt()
```

Now let us create variables, only those that are non grouped, i.e. thhose generated without using _bysort_. In R one can create grouped varibales in a different manner. Will show that in the code chunk following this one.

```{r bh_newvars}
bh_dat <- bh_dat %>% 
  mutate(
    ind_id = structure(((hh1*100000)+(hh2*100)+ln),
                       label = "Individual ID"),
    date_death = structure(bh4c + bh9c, 
                           label = "Date of Death CMC"),
    mdead_survey = structure(ifelse(((bh9c == 0 |is.na(bh9c)) & bh5 == 1),
                                     NA, 
                                     wdoi - date_death), 
                             label = "Months Dead from Survey"),
    ydead_survey = structure(mdead_survey/12, 
                             label = "Years dead from Survey"),
    age_death = structure(ifelse(bh5 == 2, bh9c, NA),
                          label = "Age at death in Months"),
    child_died = structure(forcats::as_factor(
      ifelse(is.na(bh5),NA,
             ifelse(bh5==1,"child is alive","child is dead")))),
    child18_died = forcats::as_factor(
      ifelse((!is.na(age_death) & age_death > 216),
             ifelse(is.na(bh5),NA,
                    ifelse(bh5==1,
                           "child is alive",
                           "child is dead")), 
             "child is alive"))
    )
```

Creating grouped variables.

Notice that I need not write equivalent R code for the following STATA code chunks:


1> _This has been included in the grouped condition for the variable_

replace tot_child18_died_5y=. if child18_died==1 & ydead_survey==. //Replace as '.' if there is no information on when the child died  

2> _This need not be written as the structure of data is different, only one rwo exists per ind_id_ __NOte that due to this feature there is no need to create "child18u_died_per_wom_5y" as it is same as "tot_child18_died_5y"__

bysort ind_id: egen childu18_died_per_wom_5y = max(tot_child18_died_5y) 
lab var childu18_died_per_wom_5y "Total child under 18 death for each women in the last 5 years (birth recode)"

3> _This need not be written as the structure of data is different, only one rwo exists per ind_id_

//Keep one observation per women 
bysort ind_id: gen id=1 if _n==1 keep if id==1 drop id duplicates report ind_id

```{r bh_newvars_grouped}
bh_dat %>% 
  group_by(ind_id) %>% 
  summarise(
    tot_child_died = sum(child_died == "child is dead", na.rm = T),
    tot_child18_died_5y = sum(
      child18_died[ydead_survey <= 5 & !is.na(ydead_survey)] == "child is dead", na.rm = T),
    women_BH = 1
) %>% 
  mutate(
    tot_child18_died_5y = ifelse(
      (is.na(tot_child18_died_5y) & tot_child_died>=0 & !is.na(tot_child_died)),0,tot_child18_died_5y)
  )-> grouped_bh_dat
```

Writing new files.

```{r write}
write_csv(bh_dat, here("output data files","1.2Intermediate_VNM14_BH.csv"))
write_csv(grouped_bh_dat,here("output data files","1.2VNM14_BH.csv")) # same as VNM14_BH.dta
```

#### Step 1.3: WM - Women's Record (All eligible females 15-49 in the household)

Loading data and setting case for variable (column) names.

```{r load_wm}
wm_dat <- read_sav(file = here("Viet Nam_MICS5_Datasets",
                     "Viet Nam MICS 2013-14 SPSS Datasets",
                     "wm.sav"))

wm_dat <- clean_names(wm_dat)
```

Mutating the data for creating new variables. This is what one would refere to generating new varibles in STATA, I think.

Note, for the varible marital or marital_wom, I miss to see whyn the STATA code defines it as marital to begin with and renames it to marital_wom. I will define this varibale as marital_wom from the begining itself. Kindly bring to notice if this is incorrect.

```{r wm_newvar}
wm_dat <- wm_dat %>% 
  mutate(
    ind_id = structure(((hh1*100000)+(hh2*100)+ln),
                       label = "Individual ID"),
    women_wm = 1,
    marital_wom = structure(
      forcats::as_factor(
      case_when(
        mstatus == 3 & is.na(ma6) ~ "Never Married",
        mstatus == 1 & is.na(ma6) ~ "Currently Married",
        mstatus == 2 & ma6 == 1 ~ "Widowed",
        mstatus == 2 & ma6 == 2 ~ "Divorced",
        mstatus == 2 & ma6 == 3 ~ "Seperated/Not living together",
      )
    ), label = "Marital Status of Household Member"
  )
) 

```

While creating new variables the STATA code has various tables. I will generate those here.

```{r unique ind_id}
length(unique(wm_dat$ind_id)) == nrow(wm_dat)
```

This means all Individual Ids are unique, i.e., every row represents a unique individual.

```{r cm1_cm8, warning=FALSE}
wm_dat %>% 
  tabyl(cm1, cm8,show_na = TRUE)
```

```{r mstat_ma6}
head(wm_dat[,c("mstatus","ma6")],10)
```

```{r tab_mstat_ma6, warning=FALSE}
wm_dat %>% 
  tabyl(mstatus, ma6,show_na = TRUE)

```

```{r marital_miss_tab}
wm_dat %>% 
  tabyl(marital_wom, show_na = TRUE)
```

```{r ma6_marital, warning=FALSE}
wm_dat %>% 
  tabyl(ma6, marital_wom, show_na = TRUE)
```

```{r mstatus_marital, warning=FALSE}
wm_dat %>% 
  tabyl(mstatus, marital_wom, show_na = TRUE)
```

Keeping relevant columns.

```{r keeping cols}
wm_dat <- wm_dat%>% 
  select(wm7, cm1, cm8, cm9a, cm9b, 
         ind_id, women_wm, dplyr::ends_with("_wom"))
```

Writing the tables in csv.

```{r write_wm}
write_csv(wm_dat,here("output data files","1.3VNM14_WM.csv"))
```

